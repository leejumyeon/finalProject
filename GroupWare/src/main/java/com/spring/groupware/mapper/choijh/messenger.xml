<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="messenger">

	<!-- 로그인 한 사원 정보를 제외한 모든 사원 정보 불러오기 -->
	<select id="allEmployeeView" parameterType="String" resultType="com.spring.groupware.commonVO.EmployeesVO">
		select employee_seq, employee_name, position_name, department_name
		from
		(
		    select E.employee_seq, employee_name, P.position_name, E.fk_department, P.position_seq
		    from employees_table E join position_table P
		    on   E.fk_position = P.position_seq
		) V join department_table D
		on  V.fk_department = D.department_seq
		where employee_seq != #{employee_seq} 
		order by V.position_seq
	</select>


	<!-- 채팅 방 존재유무 조회하기 -->
	<select id="roomExist" parameterType="HashMap" resultType="com.spring.groupware.commonVO.MessengerVO">
		select roomNumber
		from
		(
		select roomNumber, count(*) AS cnt
		from messengerRoom_table
		where roomNumber in (select roomNumber
		                     from messengerRoom_table 
		                     where roomNumber in(select roomNumber from messengerRoom_table where fk_employee_seq = #{sEmployee_seq})
		                           and
		                           fk_employee_seq = #{rEmployee_seq})
		group by roomNumber 
		) V    
		where cnt = 2
	</select>
	
	
	<!-- 채팅 방 번호 채번해오기 -->
	<select id="getRoomNumber" resultType="int">
		select messengerRoom_table_seq.nextval
		from dual
	</select>


	<!-- 채팅방 만들기 -->
	<insert id="createRoom_S" parameterType="HashMap">
		insert into messengerRoom_table(roomNumber, fk_employee_seq, regDate)
		values(#{roomNum}, #{sEmployee_seq}, default)
	</insert>
	<insert id="createRoom_R" parameterType="HashMap">
		insert into messengerRoom_table(roomNumber, fk_employee_seq, regDate)
		values(#{roomNum}, #{rEmployee_seq}, default)
	</insert>
	
	
	
</mapper>